---
import TerminalLayout from '../layouts/TerminalLayout.astro';
import { getCollection } from 'astro:content';

const notes = await getCollection('publish', ({ data }) => data.publish === true);

const currentYear = new Date().getFullYear();

let totalBuilds = 0;
let totalProjects = 0;
let totalNotesCount = 0;
let booksReadThisYear = 0;
const tagCounts = new Map();
let totalWordCount = 0;
let linkCount = 0;

let firstPostDate = '9999-99-99';
let latestPostDate = '0000-00-00';

for (const note of notes) {
  const date = note.data.date;
  
  if (date < firstPostDate) firstPostDate = date;
  if (date > latestPostDate) latestPostDate = date;
  
  totalWordCount += note.body?.split(/\s+/).length || 0;
  
  const filePath = note.id.toLowerCase();
  if (filePath.includes('/builds/') || note.data.type === 'build') {
    totalBuilds++;
  } else if (filePath.includes('/projects/') || note.data.type === 'project') {
    totalProjects++;
  } else {
    totalNotesCount++;
  }
  
  if ((filePath.includes('/books/') || note.data.type === 'reading') && date.startsWith(currentYear.toString())) {
    if (note.body?.toLowerCase().includes('status') && (note.body?.toLowerCase().includes('read') || note.body?.toLowerCase().includes('finished'))) {
      booksReadThisYear++;
    }
  }
  
  for (const tag of note.data.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}

const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5)
  .map(([tag, count]) => ({ tag, count }));

const stats = {
  totalNotes: notes.length,
  totalBuilds,
  totalProjects,
  totalNotesCount,
  booksReadThisYear,
  totalTags: tagCounts.size,
  topTags: sortedTags,
  totalWordCount,
  firstPostDate: firstPostDate === '9999-99-99' ? 'N/A' : firstPostDate,
  latestPostDate: latestPostDate === '0000-00-00' ? 'N/A' : latestPostDate,
  linkCount
};
---

<TerminalLayout title="stats">
  <div class="pane" style="grid-column: 1 / -1; grid-row: 1 / -1; overflow: auto;">
    <div class="pane-header">stats</div>
    
    <section class="mb-6">
      <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 16px;">
        <div>
          <div class="text-3xl text-accent">{stats.totalNotes}</div>
          <div class="text-meta">total notes</div>
        </div>
        <div>
          <div class="text-3xl text-accent">{stats.totalBuilds}</div>
          <div class="text-meta">builds</div>
        </div>
        <div>
          <div class="text-3xl text-accent">{stats.totalProjects}</div>
          <div class="text-meta">projects</div>
        </div>
        <div>
          <div class="text-3xl text-accent">{stats.booksReadThisYear}</div>
          <div class="text-meta">books read (this year)</div>
        </div>
        <div>
          <div class="text-3xl text-accent">{stats.totalWordCount.toLocaleString()}</div>
          <div class="text-meta">total words</div>
        </div>
        <div>
          <div class="text-3xl text-accent">{stats.linkCount}</div>
          <div class="text-meta">total links</div>
        </div>
      </div>
    </section>

    <section class="mb-6">
      <h2 class="text-meta mb-2">// timeline</h2>
      <table class="w-full" style="border-collapse: collapse;">
        <tbody>
          <tr>
            <td class="py-1 text-meta">first post</td>
            <td class="py-1">{stats.firstPostDate}</td>
          </tr>
          <tr>
            <td class="py-1 text-meta">latest post</td>
            <td class="py-1">{stats.latestPostDate}</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="mb-6">
      <h2 class="text-meta mb-2">// top tags</h2>
      <div>
        {stats.topTags.length > 0 ? (
          stats.topTags.map((tag) => (
            <span class="mr-4">
              <span class="text-accent">{tag.tag}</span>
              <span class="text-meta ml-1">({tag.count})</span>
            </span>
          ))
        ) : (
          <span class="text-meta">no tags</span>
        )}
      </div>
    </section>
  </div>
</TerminalLayout>
