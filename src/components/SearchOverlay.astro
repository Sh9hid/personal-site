<div id="search-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center pt-[15vh]">
  <div class="w-full max-w-2xl bg-[#0a0a0a] border border-[#00aa2a]/30 rounded-lg shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
    <div class="border-b border-[#00aa2a]/30 px-4 py-3">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-[#00aa2a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          id="search-input"
          placeholder="Search the site..."
          class="flex-1 bg-transparent text-[#00ff41] placeholder-[#00aa2a]/50 outline-none text-lg font-mono"
          autocomplete="off"
        />
        <kbd class="px-2 py-1 bg-[#00aa2a]/20 rounded text-xs text-[#00aa2a]">?</kbd>
      </div>
    </div>
    
    <div id="search-results" class="max-h-[50vh] overflow-y-auto">
      <div class="px-4 py-8 text-center text-[#00aa2a]">
        Type to search...
      </div>
    </div>
    
    <div class="border-t border-[#00aa2a]/30 px-4 py-2 text-xs text-[#00aa2a] flex items-center gap-4">
      <span><kbd class="px-1.5 py-0.5 bg-[#00aa2a]/20 rounded">↑↓</kbd> navigate</span>
      <span><kbd class="px-1.5 py-0.5 bg-[#00aa2a]/20 rounded">↵</kbd> go</span>
      <span><kbd class="px-1.5 py-0.5 bg-[#00aa2a]/20 rounded">esc</kbd> close</span>
    </div>
  </div>
</div>

<script>
  let pagefind = null;
  let selectedIndex = 0;
  let currentResults = [];
  
  const overlay = document.getElementById('search-overlay');
  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');
  
  async function initPagefind() {
    if (pagefind) return;
    try {
      // @ts-ignore
      pagefind = await window.pagefind;
    } catch (e) {
      console.log('Pagefind not available');
    }
  }
  
  function openSearch() {
    overlay.classList.remove('hidden');
    input.value = '';
    currentResults = [];
    selectedIndex = 0;
    renderResults();
    setTimeout(() => input.focus(), 0);
    initPagefind();
  }
  
  function closeSearch() {
    overlay.classList.add('hidden');
  }
  
  function renderResults() {
    if (!currentResults.length) {
      results.innerHTML = `<div class="px-4 py-8 text-center text-[#00aa2a]">${input.value ? 'No results found' : 'Type to search...'}</div>`;
      return;
    }
    
    results.innerHTML = currentResults.map((r, i) => `
      <a
        href="${r.url}"
        class="search-result block px-4 py-3 border-b border-[#00aa2a]/10 transition-colors ${i === selectedIndex ? 'bg-[#00ff41]/10' : 'hover:bg-[#00aa2a]/10'}"
      >
        <div class="font-medium text-[#00ff41]">${r.title || ''}</div>
        <div class="text-sm text-[#00aa2a] line-clamp-2">${r.excerpt || ''}</div>
      </a>
    `).join('');
    
    const selected = results.children[selectedIndex];
    if (selected) selected.scrollIntoView({ block: 'nearest' });
  }
  
  async function performSearch(query) {
    if (!query.trim()) {
      currentResults = [];
      renderResults();
      return;
    }
    
    if (!pagefind) {
      await initPagefind();
    }
    
    if (pagefind) {
      try {
        const search = await pagefind.search(query);
        const data = await Promise.all(
          search.results.slice(0, 10).map(async (r) => ({
            url: r.url,
            ...await r.data()
          }))
        );
        currentResults = data;
        selectedIndex = 0;
        renderResults();
      } catch (e) {
        console.log('Search error:', e);
      }
    }
  }
  
  let searchTimeout;
  input?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(e.target.value), 300);
  });
  
  input?.addEventListener('keydown', (e) => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
        renderResults();
        break;
      case 'ArrowUp':
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        renderResults();
        break;
      case 'Enter':
        e.preventDefault();
        if (currentResults[selectedIndex]) {
          window.location.href = currentResults[selectedIndex].url;
        }
        break;
      case 'Escape':
        closeSearch();
        break;
    }
  });
  
  overlay?.addEventListener('click', (e) => {
    if (e.target === overlay) closeSearch();
  });
  
  window.addEventListener('open-pagefind-search', openSearch);
  window.addEventListener('open-search', openSearch);
  window.addEventListener('close-overlays', closeSearch);
  
  document.addEventListener('keydown', (e) => {
    const target = e.target;
    const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;
    
    if (e.key === '?' && !isInput) {
      e.preventDefault();
      openSearch();
    }
    
    if (e.key === 'Escape') {
      closeSearch();
    }
  });
</script>
